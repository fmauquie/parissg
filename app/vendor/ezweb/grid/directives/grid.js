define(["angular","jquery","../utilities","ez-i18n!../locales","../../i18n/main","../vendor/datatable.bootstrap","../vendor/jquery.dataTables","less!../styles/grid"],function(a,b,c,d){"use strict";function e(b,c,d,e,f,g,h){a.isUndefined(e[b])&&d.$watch("$parent.ezweb.responsive.breakpoint",function(d){a.isDefined(d)&&(a.isDefined(f[b])&&"xs"!==d?(a.isUndefined(h)?delete f[b]:f[b]=h,g.reload(!0)):a.isUndefined(f[b])&&"xs"===d&&(f[b]=c,g.reload(!0)))})}function f(b,c,d){var e=-1;a.forEach(c.columns,function(f){if(f.visible!==!1){e++;var g=!1;a.forEach(c.columnsFilters,function(a){a.attrs.name===f.name&&(d(f,a,b.children("th").eq(e)),g=!0)}),g===!1&&d(f)}})}function g(a,c){var d=b('<tr ez-role="search" class="ez-auto-filter ez-filters '+c+'"></tr>');return f(d,a,function(a){d.append('<th class="ez-auto-filter" ez-name="'+a.name+'"></th>')}),d}function h(a,c){var d=!0;f(a,c,function(a,c,e){var f=b('<span class="ez-filter ez-auto-filter"></span>');f.append(c.element.clone()),f.on("click",function(a){a.stopImmediatePropagation()}),e.append(f),d===!0&&(e.addClass("ez-filter-indicator"),d=!1)})}function i(b,c,d){b.language=d.language,a.forEach(l,function(e,f){var g=d.language[f];c.$watch(g,function(c){b.language[f]=c,a.isDefined(d.reload)&&d.reload(!0)})})}function j(b,c,d){a.isDefined(d.stateSaveCallback)&&(b.stateSaveCallback=function(a,b){return c.stateSaveCallback({settings:a,data:b})}),a.isDefined(d.stateLoadCallback)&&(b.stateLoadCallback=function(a){return c.stateLoadCallback({settings:a})}),a.isDefined(d.stateSaveParams)&&(b.stateSaveParams=function(a,b){return c.stateSaveParams({settings:a,data:b})}),a.isDefined(d.stateLoadParams)&&(b.stateLoadParams=function(a,b){return c.stateLoadParams({settings:a,data:b})}),a.isDefined(d.stateLoaded)&&(b.stateLoaded=function(a,b){return c.stateLoaded({settings:a,data:b})})}b.extend(b.fn.dataTableExt.oStdClasses,{sWrapper:"dataTables_wrapper"});var k={emptyTable:"'ezweb.grid:emptyTable' | i18next",thousands:"'ezweb.grid:thousands' | i18next",lengthMenu:"'ezweb.grid:lengthMenu' | i18next",loadingRecords:"'ezweb.grid:loadingRecords' | i18next",processing:"'ezweb.grid:processing' | i18next",search:"'ezweb.grid:search' | i18next",zeroRecords:"{{'ezweb.grid:zeroRecords' | i18next}}",paginate:{first:"{{'ezweb.grid:paginate.first' | i18next}}",last:"{{'ezweb.grid:paginate.last' | i18next}}",next:"{{'ezweb.grid:paginate.next' | i18next}}",previous:"{{'ezweb.grid:paginate.previous' | i18next}}"},aria:{sortAscending:"{{'ezweb.grid:aria.sortAscending' | i18next}}",sortDescending:"{{'ezweb.grid:aria.sortDescending' | i18next}}"}},l={emptyTable:!0,thousands:!0,lengthMenu:!0,loadingRecords:!0,processing:!0,search:!0};return a.module("ezweb.grid.directives",["ezweb.core.services.responsive","ezweb.i18n"]).config(["ezweb.i18n.configurationProvider",function(a){a.registerIfNotDefined("ezweb.grid","en",d)}]).directive("ezGrid",["$timeout","$compile","ezweb.core.services.responsive",function(d,f,m){var n=-1;return{restrict:"EA",template:'<div><table class="{{ezTableClass}}"></table><div class="hidden" ng-transclude></div></div>',transclude:!0,replace:!0,scope:{data:"=?",serverSideData:"&?",value:"@",api:"=?",reloadData:"=?",autoWidth:"&",deferRender:"&",info:"&",lengthChange:"&",ordering:"&",paging:"&",processing:"&",scrollX:"&",scrollY:"&",searching:"&",stateSave:"&",displayStart:"&",dom:"@",lengthMenu:"&",order:"&",orderCellsTop:"&",orderClasses:"&",orderFixed:"&",orderMulti:"&",pageLength:"&",pagingType:"@",scrollCollapse:"&",scrollInfinite:"&",initialSearch:"@",stateDuration:"&",stripeClasses:"&",tabIndex:"&",ezHideMobileHeader:"&",ezTableClass:"@",ezColumnsFiltersPositions:"&",stateSaveCallback:"&",stateLoadCallback:"&",stateSaveParams:"&",stateLoadParams:"&",stateLoaded:"&",ezNoSearchBox:"&"},controller:["$scope",function(b){this.api=null,this.reloadData=null,this.reload=null,this.tableId=++n,this.columns=[],this.rowAttributes=null,this.columnsFilters={},this.columnsFiltersPositions={},this.valueName=a.isDefined(b.value)?b.value:"value",this.language=a.copy(k);var c=[];this.setSearch=function(c){if(a.isDefined(b.search))throw"Search is already defined";b.search=c},this.setVisible=function(a,b){this.api.column(a+":name").visible(b,!1),this.reload(!1)},this.addColumnFilter=function(a){this.columnsFilters[a.attrs.name]=a},this.setLanguageAttribute=function(b,c){if(a.isDefined(l[b])&&(c.indexOf("{{")>=0||0===c.indexOf("<")))throw"Grid i18n: "+b+" is supposed to be a plain angular expression";for(var d=b.split("."),e=this.language;d.length>1;)e=e[d.shift()];e[d.shift()]=c},this.addPlugin=function(a){c.push(a)},this.startPlugins=function(){a.forEach(c,a.bind(this,function(a){a.call(this.api,this.api)}))}}],link:function(k,l,n,o){if(a.isDefined(n.data)&&a.isDefined(n.serverSideData))throw'You must choose between "data" and "server-side-data" !';var p=c.createConfigFromScope(k,["autoWidth","deferRender","info","lengthChange","ordering","paging","processing","scrollX","scrollY","searching","serverSide","stateSave","displayStart","lengthMenu","order","orderCellsTop","orderClasses","orderFixed","orderMulti","pageLength","scrollCollapse","stateDuration","stripeClasses","tabIndex"]);delete p.data,delete p.serverSideData,delete p.ezHideMobileHeader,delete p.ezTableClass,delete p.api,a.isUndefined(p.deferRender)&&(p.deferRender=!0),p.renderer="bootstrap",p.destroy=!0;var q=p.dom?p.dom:"<'row form-inline'<'col-xs-6'l><'col-xs-6'f>r>t<'row form-inline'<'col-xs-6'i><'col-xs-6'p>>";!n.ezNoSearchBox||""!==n.ezNoSearchBox&&k.ezNoSearchBox()!==!0||(q=q.replace(/f/g,"")),p.dom=q,e("paging",!1,k,n,p,o),e("scrollY",640,k,n,p,o),e("scrollInfinite",!0,k,n,p,o),e("scrollCollapse",!0,k,n,p,o),e("dom","<f><tr>",k,n,p,o,q);var r=k.ezColumnsFiltersPositions();if(r=a.isString(r)?[r]:r,a.forEach(r,function(a){o.columnsFiltersPositions[a]=!b.isEmptyObject(o.columnsFilters)}),i(p,k,o),j(p,k,n),a.isDefined(k.initialSearch)){if(a.isDefined(k.search))throw k.search===!1?'Search is disabled on the grid (searching="false")':"Search is already defined";p.search={search:k.initialSearch}}p.createdRow=function(b,d){var e=c.initRowScope(d,k.$parent,o).scope,g=a.element(b);a.forEach(o.rowAttributes,function(a,b){"class"===b?g.addClass(a):0!==b.indexOf("$")&&g.attr(o.rowAttributes.$attr[b],a)}),g.addClass("ez-grid-cloak"),f(g)(e),e.$evalAsync(function(){g.removeClass("ez-grid-cloak")})},o.addPlugin(function(){a.forEach(o.columnsFilters,function(a){k.$parent.$watch(a.attrs.ezModel,function(b){o.api.column(a.attrs.name+":name").search(b?b:"").draw()})})}),p.headerCallback=function(c){var d;if(a.isUndefined(c)?(d=b("<thead></thead>"),l.find("table").prepend(d)):d=b(c).closest("thead"),(a.isUndefined(n.ezHideMobileHeader)||k.ezHideMobileHeader())&&("xs"===m.breakpoint?d.hide():d.is(":hidden")&&d.show()),o.columnsFiltersPositions.headerEmbedded===!0&&0===d.find(".ez-filters-embedded .ez-filter-indicator .ez-filter").size()){var e=d.children(".ez-filters-embedded");0===e.size()&&(e=d.children("tr").eq(0),e.addClass("ez-filters-embedded")),h(e,o)}if(o.columnsFiltersPositions.header===!0&&0===d.find(".ez-filters-header .ez-filter-indicator .ez-filter").size()){var i=g(o,"ez-filters-header");h(i,o),d.prepend(i)}d.addClass("ez-grid-cloak"),f(d)(k.$parent),k.$parent.$evalAsync(function(){d.removeClass("ez-grid-cloak")}),d.find("span.ez-filter").addClass("ng-non-bindable")},p.footerCallback=function(){var a=l.find("table > tfoot");if(o.columnsFiltersPositions.footer===!0&&0===a.find(".ez-filters-footer .ez-filter-indicator .ez-filter").size()){0===a.size()&&(a=b("<tfoot></tfoot>"),l.find("table").append(a));var c=g(o,"ez-filters-footer");h(c,o),a.prepend(c),f(a)(k.$parent)}};var s=k.$parent.$new();if(p.infoCallback=function(b,c,d,e,g){a.extend(s,{start:c,end:d,total:g,max:e}),s.$$phase||s.$apply();var h=l.find(".dataTables_info");h.size()>0&&(h.hasClass("ez-info")||(h.append("<span ng-i18next=\"[html:i18next]({start:'{{start|number}}',end:'{{end|number}}',total:'{{total|number}}'})ezweb.grid:info\"></span>"),h.append("{{'ezweb.grid:infoPostFix' | i18next}} "),h.append('<span ng-if="total != max" ng-i18next="[html:i18next]({max:\'{{max|number}}\'})ezweb.grid:infoFiltered"></span>'),h.addClass("ez-info ez-grid-cloak"),f(h)(s),s.$evalAsync(function(){h.removeClass("ez-grid-cloak")})))},p.drawCallback=function(a){var c=b(a.nTBody).children(":first").children("td:first");c.hasClass(a.oClasses.sRowEmpty)&&(c.addClass("ez-grid-cloak"),f(c)(k.$parent),k.$parent.$evalAsync(function(){c.removeClass("ez-grid-cloak")}));var d=l.find(".dataTables_paginate");d.size()>0&&!d.hasClass("ez-pagination")&&(d.addClass("ez-pagination ez-grid-cloak btn-group"),d.children().each(function(){b(this).on("$destroy",function(){d.removeClass("ez-pagination")})}),d.find(".paginate_button").addClass("btn btn-default").removeClass("paginate_button"),f(d)(k.$parent),k.$parent.$evalAsync(function(){d.removeClass("ez-grid-cloak")}))},p.columns=o.columns,a.isDefined(n.data)){p.serverSide=!1,p.ajax=function(b,c){a.isDefined(k.data)&&null!==k.data&&(a.isUndefined(k.data.$resolved)||k.data.$resolved===!0)&&(c({data:k.data}),k.$evalAsync(function(){l.find("table").css("width","100%"),l.find("th").css("width",""),o.api.columns.adjust()}))};var t=function(b){null!==o.reload&&a.isDefined(b)&&null!==b&&(a.isUndefined(b.$resolved)||b.$resolved===!0)&&o.reload()};k.$watchCollection("data",t),k.$watch("data.$resolved",t)}else a.isDefined(n.serverSideData)&&(p.serverSide=!0,p.ajax=function(b,c){k.serverSideData({config:b,callback:function(b,d,e){if(a.isUndefined(b)||null===b||a.isUndefined(d)||null===d||a.isUndefined(e)||null===e)throw"All parameters to the callback function are mandatory.";c({data:b,recordsTotal:e,recordsFiltered:d,draw:b.draw})}})});var u=null,v=!1,w=function(){null!==o.api&&(o.api.destroy(),o.api=null,o.reloadData=null,l.find("table").replaceWith('<table class="'+k.ezTableClass+'"></table>')),o.api=l.children("table").dataTable(a.copy(p)).api(),o.reloadData=o.api.ajax.reload,o.startPlugins(),k.api=o.api,k.reloadData=o.reloadData,v=!1};o.reload=function(a){a===!0?(v=!0,null!==u&&d.cancel(u),p.destroy=!0,u=d(w,100)):v===!1&&(null!==u&&d.cancel(u),u=d(function(){o.reloadData()},100))},o.reload(!0)}}}]).directive("ezGridColumn",["$interpolate",function(b){return{restrict:"EA",priority:1e3,terminal:!0,require:"^ezGrid",scope:{cellType:"@","class":"@",contentPadding:"@",defaultContent:"@",name:"@",orderable:"&",orderData:"&",orderDataType:"@",orderSequence:"&",searchable:"&",title:"@",ezI18nTitle:"@",ezBoundTitle:"@",type:"@",visible:"&",width:"@",ezFilter:"@",ezSort:"@"},link:function(d,e,f,g){var h=c.createConfigFromScope(d,["orderable","orderData","orderSequence","searchable","visible"]);if(delete h.ezFilter,delete h.ezSort,delete h.ezI18nTitle,a.isDefined(f.ezI18nTitle)&&a.isDefined(f.title))throw"Column "+h.name+" defines both title and i18n title.";a.isDefined(f.ezI18nTitle)&&(h.title="<span ng-bind=\"'"+d.ezI18nTitle+"' | i18next:{'defaultLoadingValue':''}\"></span>"),a.isDefined(f.ezBoundTitle)&&(h.title='<span ng-bind="'+d.ezBoundTitle+'"></span>');var i=a.isDefined(h.visible)?h.visible:!0;d.$watch("visible()",function(b){if(a.isDefined(b)&&b!==i){if(a.isUndefined(d.name)||""===d.name)throw'Changing the visibility of a column dynamically requires it to be named. Add a "name" attribute to ez-table-column.';i=b,h.visible=b,g.setVisible(h.name,b)}}),h.render=function(a,f,i){var j,k=c.initRowScope(i,d.$parent,g).scope;switch(f){case"filter":j=h.searchable===!1?"":d.ezFilter?k.$eval(d.ezFilter)||"":b(e.text())(k);break;case"sort":j=h.orderable===!1?"":d.ezSort?k.$eval(d.ezSort)||"":b(e.text())(k);break;default:j=e.html()}return j},h.createdCell=function(b,e,h,i){var j=c.initRowScope(h,d.$parent,g).scope;j.$index=i;var k=a.element(b);a.forEach(f,function(b,c){"class"===c?k.addClass(b):a.isUndefined(d[c])&&0!==c.indexOf("$")&&k.attr(f.$attr[c],b)})},g.columns.push(h)}}}]).directive("ezGridSearch",[function(){return{restrict:"EA",require:"^ezGrid",scope:{caseInsensitive:"&",regexp:"&",smart:"&",search:"@"},link:{pre:function(a,b,d,e){e.setSearch(c.createConfigFromScope(a,["caseInsensitive","regexp","smart"]))},post:function(){}}}}]).directive("ezGridRows",[function(){return{restrict:"EA",require:"^ezGrid",scope:{},link:{pre:function(a,b,c,d){d.rowAttributes=c},post:function(){}}}}]).directive("ezGridColumnFilter",[function(){return{restrict:"EA",require:"^ezGrid",terminal:!0,scope:{name:"@",ezModel:"@"},link:function(a,b,c,d){d.addColumnFilter({attrs:c,element:b.children()})}}}]).directive("ezGridI18n",[function(){return{restrict:"E",require:"^ezGrid",terminal:!0,scope:{name:"@"},link:function(a,b,c,d){d.setLanguageAttribute(a.name,b.html())}}}])});