"use strict";define(["module","angular","jquery"],function(a,b,c){return b.module("ezweb.auth.services",[]).provider("ezweb.auth.services.users",[function(){var a={username:null,roles:[],connected:!1},c=!1,d=!1;this.$get=function(e,f,g,h){if(!b.isFunction(e.login))throw"Backend doesn't define the login() function. See docs.";if(!b.isFunction(e.logout))throw"Backend doesn't define the logout() function. See docs.";if(!b.isFunction(e.current))throw"Backend doesn't define the current() function. See docs.";return g.ensure("backends",{users:{hasRememberMe:e.supportsRememberMe()}}),g.ensure("user",b.extend({},a,{logout:function(){return g.user.connected===!0?e.logout().then(function(){return h.$broadcast("ezweb.logout",g.user),b.extend(g.user,a),g.user}):f.when(this)},considerLoggedOut:function(){b.extend(g.user,a)},login:function(a,c,i){return g.user.connected===!0?f.reject("User is already logged in."):e.login(a,c,i).then(function(a){return b.extend(g.user,a),g.user.connected=!0,d=!0,h.$broadcast("ezweb.login",g.user),g.user})},get:function(a){return a=a?a:b.noop,d===!0?(a(g.user),g.user):c!==!1?(c=c.then(function(){return a(g.user),g.user}),g.user):(c=e.current().then(function(e){return b.extend(g.user,e),g.user.connected=!0,a(g.user),c=!1,d=!0,g.user},function(){c=!1}),g.user)},consider:function(a){b.extend(g.user,a)}})),g.user.get(),g.user},this.$get.$inject=["ezweb.auth.services.users.backend.none","$q","ezweb.core.services.scope","$rootScope"],this.configure=function(a){if(0===arguments.length||null===a)throw"No backend defined";this.$get.$inject[0]=a}}]).provider("ezweb.auth.services.users.backend.default",[function(){var a={usernameParameter:"username",passwordParameter:"password",rememberMeParameter:"rememberme",supportsRememberMe:!0,loginUri:"login",logoutUri:"logout",currentUserUri:"rest/users/current"},d=a;this.configure=function(c){d=b.extend({},a,c)},this.$get=["$http","$q",function(a,b){return{login:function(a,e,f){var g={};g[d.usernameParameter]=a,g[d.passwordParameter]=e,d.supportsRememberMe===!0&&(g[d.rememberMeParameter]=f?f:!1);var h=b.defer();return c.post(d.loginUri,g).success(function(a){a.username&&""!==a.username?h.resolve(a):h.reject("Wrong username or password.")}).error(function(){return h.reject("Server error. Please try again. If the problem persists, contact your administrator.")}),h.promise},logout:function(){return a.get(d.logoutUri)},current:function(){return a.get(d.currentUserUri).then(function(a){return a.data})},supportsRememberMe:function(){return d.supportsRememberMe}}}]}]).factory("ezweb.auth.services.users.backend.none",["$q",function(a){var b=function(){return a.reject("No backend chosen. Use ezweb.auth.services.users.configure() in a angular.module.run() block.")};return{login:b,logout:b,current:b,supportsRememberMe:function(){return!1}}}])});