"use strict";define(["angular","text!../views/basicTypeahead.html"],function(a,b){var c="ezTypeahead";return a.module("ezweb.form.directives.typeahead",[]).directive(c,["$timeout","$q",function(b,c){return{restrict:"E",transclude:"element",scope:{ezFilter:"&",ezItems:"@",ezThrottle:"&",ezThreshold:"&",ezHideOnBlur:"&"},controller:["$scope","$element","$attrs",function(d,e,f){this.$parentContainer=null;var g=null,h=function(a){null!==g&&g.removeClass("active"),null===a?g=null:(g=a,g.addClass("active"))};this.reset=function(){h(null),d.visible=!1},this.resetBlur=function(){a.isDefined(f.ezHideOnBlur)&&""!==f.ezHideOnBlur&&d.ezHideOnBlur()===!1||b(a.bind(this,function(){this.reset()}),200)},this.next=function(){var a=this.$parentContainer.find("[ez-typeahead-item]");if(null===g)h(a.first());else if(g.is(a.last()))h(null);else{var b=a.index(g);h(a.eq(b+1))}},this.previous=function(){var a=this.$parentContainer.find("[ez-typeahead-item]");if(null===g)h(a.last());else if(g.is(a.first()))h(null);else{var b=a.index(g);h(a.eq(b-1))}};var i=null,j=!0;d.visible=!1,d.selectCallbackInProgress=!1;var k=d.$parent.$new(),l=function(){var b=d.ezFilter();if(a.isDefined(b)){var e;if(a.isFunction(b.then))e=b;else if(a.isDefined(b.$promise))e=b.$promise;else{if(!a.isArray(b)&&!a.isObject(b))throw"Can't understand the promise sent by the typeahead filter: {{"+f.ezFilter+"}}.";var g=c.defer();e=g.promise,g.resolve(b)}e.then(p)}};this.modelChange=function(c){j===!0?j=!1:a.isString(c)?(null!==i&&b.cancel(i),this.reset(),i=b(function(){d.selectCallbackInProgress?d.selectCallbackInProgress=!1:c.length>=n()?(d.visible=!0,l()):d.visible=!1},m())):(d.visible=!0,l())},this.keyDown=function(c){b(a.bind(this,function(){if(d.visible===!0){var a=!1;if(40===c.keyCode)this.next(),a=!0;else if(38===c.keyCode)this.previous(),a=!0;else if(13===c.keyCode&&null!==g){if(g.is("a, [ng-click]"))g.click();else{if(1!==g.find("a, [ng-click]").eq(0).length)throw"You must set ng-click on the item";g.find("a, [ng-click]").eq(0).click()}a=!0}else 27===c.keyCode&&(this.reset(),a=!0);a===!0&&(c.preventDefault(),c.stopPropagation())}}),0)};var m=a.isDefined(f.ezThrottle)?d.ezThrottle:function(){return 300},n=a.isDefined(f.ezThreshold)?d.ezThreshold:function(){return 3},o=[],p=function(){if(a.forEach(o,function(a){delete k[a]}),a.isUndefined(arguments[0]))throw"The ezTypeahead filter callback was called without arguments.";if(a.isArray(arguments[0])){if(a.isUndefined(f.ezItems))throw"We don't know where to put the typeahead filter result, because ezItems is not defined and you used callback(Array). Define the ez-items attribute on ez-typeahead or use the callback(String, *) or callback(Object) constructs.";k[d.ezItems]=arguments[0],o=[d.ezItems]}else{if(!a.isObject(arguments[0]))throw"Unknown construct for the ezTypeahead filter callback.";o=[],a.forEach(arguments[0],function(a,b){k[b]=a,o.push(b)})}};this.bindTransclude=function(b){return function(){return a.isFunction(arguments[0])?b(k,arguments[0]):b.apply(null,arguments)}},this.configure=function(b,c){d.ezFilter=b,a.extend(k,c)}}],link:function(b,c,d,e,f){for(var g=null,h=c;null===g&&!h.is("html");)g=h.controller("formDirective"),h=h.parent();if(a.isUndefined(g))throw"ezTypeahead must be a child of a EZWeb form directive (e.g. ezFormText)";g.setTypeahead(e,e.bindTransclude(f)),e.$parentContainer=g.$typeaheadPlaceholder,e.$parentContainer.on("click.ez-typeahead",function(){b.selectCallbackInProgress=!0,b.visible=!1}),b.$watch("visible",function(a){a===!0?g.showTypeahead():g.hideTypeahead()}),g.$input.on("keydown.formDirective.typeahead",function(a){e.keyDown(a)}),g.$input.on("blur.formDirective.typeahead",function(){e.resetBlur()}),g.$input.on("focus.formDirective.typeahead",function(){e.modelChange(g.ngModelController.$modelValue)})}}}]).directive("ezTypeaheadBasic",["$q","limitToFilter","orderByFilter",function(c,d,e){return{restrict:"A",require:"formDirective",scope:{ezTypeaheadBasic:"&",ezTypeaheadLimit:"&",ezTypeaheadOrderBy:"@",ezTypeaheadThreshold:"&",ezTypeaheadThrottle:"&",ezTypeaheadItemValue:"&",ezTypeaheadHideOnBlur:"&"},priority:1e3,compile:function(f,g){if(""===g.ezTypeaheadBasic)throw"The basic typeahead requires a filter expression in the ezTypeaheadBasic attribute.";var h=a.element(b);return h.attr("ez-threshold",g.ezTypeaheadThreshold||null),h.attr("ez-throttle",g.ezTypeaheadThrottle||null),h.attr("ez-hide-on-blur",g.ezTypeaheadHideOnBlur||null),f.append(h),function(b,f,g,h){h.typeaheadController.configure(function(){var f,h=b.ezTypeaheadBasic();if(a.isFunction(h.then))f=h;else if(a.isArray(h)){var i=c.defer();f=i.promise,i.resolve(h)}else{if(!a.isDefined(h.$promise))throw"Can't understand the promise sent by the typeahead filter: {{"+g.ezTypeaheadBasic+"}}.";f=h.$promise}return f.then(function(a){var c=g.ezTypeaheadOrderBy?e(a,b.ezTypeaheadOrderBy):a;return d(c,g.ezTypeaheadLimit?b.ezTypeaheadLimit():5)})},{setModelValue:function(a){h.ngModelController.$setViewValue(a,"typeahead"),h.ngModelController.$render()},extractItemValue:function(a){return g.ezTypeaheadItemValue?b.ezTypeaheadItemValue({item:a}):a}})}}}}])});